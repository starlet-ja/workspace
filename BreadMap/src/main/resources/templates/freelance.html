<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Step1.Leafletで地理院地図を表示する最も基本的なコード|Lefletの基本|埼玉大学谷謙二研究室</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.3.0/dist/leaflet.js"></script>
  <script>
	function getGridSizeByZoom(zoom) {
	if (zoom >= 15) return 0.01;
	else if (zoom >= 13) return 0.05;
	else if (zoom >= 10) return 0.5;
	else return 1.0;
	}
    
    function init() {
      //地図を表示するdiv要素のidを設定
      var map = L.map('mapcontainer', {
		minZoom:9,
		maxZoom:18,
		maxBounds: [
    		[20.0, 122.0],
    		[46.0, 153.0]
  		],
		zoomControl: false
	  });
      //地図の中心とズームレベルを指定
      map.setView([37.40, 140.39], 13);
      //表示するタイルレイヤのURLとAttributionコントロールの記述を設定して、地図に追加する
	  // https://tile.openstreetmap.org
	  // https://cyberjapandata.gsi.go.jp/xyz/std
	  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
      }).addTo(map);

	  let gridLayers = [];
	  // グリッドサイズ（緯度・経度での正方形サイズ）
	  // const gridSize = 0.01;
	  function clearGrid() {
        gridLayers.forEach(layer => map.removeLayer(layer));
        gridLayers = [];
  	  }

	  // マップに描画されている矩形を管理
	  let rectGroup = L.layerGroup().addTo(map);
	  // マップに描画されている文字を管理
	  let markerGroup = L.layerGroup().addTo(map);

	  let rect = null;
	  let marker = null;
	  function drawGrid() {
		if (rect != null) {
			// map.removeLayer(rect);
			rectGroup.clearLayers();
			markerGroup.clearLayers();
		}
		clearGrid();
		const zoom = map.getZoom();
		console.log(zoom);
		const gridSize = getGridSizeByZoom(zoom);
		console.log(gridSize);
	    const bounds = map.getBounds();
	    const south = bounds.getSouth();
	    const north = bounds.getNorth();
	    const west = bounds.getWest();
	    const east = bounds.getEast();

	    for (let lat = Math.floor(south / gridSize) * gridSize; lat < north; lat += gridSize) {
	      for (let lng = Math.floor(west / gridSize) * gridSize; lng < east; lng += gridSize) {
			let bounds = [[lat, lng],[lat + gridSize, lng + gridSize]]
	        rect = L.rectangle(bounds,
			{
	          color: "#ff7800",
	          weight: 1,
	          fillOpacity: 0
	        }).addTo(map);

			// 中心座標を計算
			let centerLat = (bounds[0][0] + bounds[1][0]) / 2;
			let centerLng = (bounds[0][1] + bounds[1][1]) / 2;

			// boundsをバックエンドに送って対象範囲の登録IDを取得
			

			// divIconでテキストを定義
			const label = L.divIcon({
				className: 'custom-label',
				// 対象範囲に登録されている人数を表示し、詳細ページへのリンクを貼る
				html: '<div style="color:red; font-weight:bold; font-size:50px;"><a href="https://zenn.dev/uzuprg/articles/8b83ee58fc45bd">27</a></div>',
				iconSize: [0, 0] // サイズゼロで位置のみ使う
			});

			// 中心にテキストを表示
			marker = L.marker([centerLat, centerLng], { icon: label }).addTo(map);
			
			// 矩形をグループ管理
			rectGroup.addLayer(rect);

			// マーカーをグループ管理
			markerGroup.addLayer(marker);
	      }
	    }
	  }

	  map.on('moveend', drawGrid);
	  drawGrid();
	  
    }
  </script>
</head>
<body onload="init()">
  <div id="mapcontainer" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>
</body>
</html>